import pytest
import json
import logging as log

from assemblyline_v4_service.common.result import BODY_FORMAT
from .utils import hatching_result_instance


def test_build_malware_extract_credentials_sub_section(
    hatching_result_instance: hatching_result_instance,
):
    """Validate the happy path. This validates both static and dynamic report scenarios.

    A ResultKeyValueSection is created with the appropriate key-values, associated heuristic, and tags.
    """

    #
    # Validate from static report data
    #
    # Extract from a static analysis report: extracted[].dropper
    credentials = {
        "flow": 1,
        "protocol": "http",
        "host": "badsite1.org",
        "port": 1234,
        "username": "user1",
        "password": "mypass",
    }

    section = hatching_result_instance._build_malware_extract_credentials_sub_section(
        credentials=credentials, is_static_analysis=True
    )

    assert section is not None
    assert section.title_text == "Extracted Credentials"
    assert section.body_format == BODY_FORMAT.KEY_VALUE

    # log.warning(section.body)
    assert json.loads(section.body) == {
        "flow": 1,
        "protocol": "http",
        "host": "badsite1.org",
        "port": 1234,
        "username": "user1",
        "password": "mypass",
    }

    assert section.heuristic.heur_id == 103
    assert section.heuristic.attack_ids == []
    assert section.heuristic.signatures == {}
    assert section.heuristic.score == 0

    # log.warning(section.tags)
    assert section.tags == {
        "info.password": ["mypass"],
        "network.static.domain": ["badsite1.org"],
        "network.port": [1234],
        "network.protocol": ["http"],
    }
    assert len(section.subsections) == 0

    #
    # Validate the same data, but when coming from a dynamic triage report
    #
    section = hatching_result_instance._build_malware_extract_credentials_sub_section(
        credentials=credentials, is_static_analysis=False
    )

    assert section is not None
    assert section.title_text == "Extracted Credentials"
    assert section.body_format == BODY_FORMAT.KEY_VALUE

    # log.warning(section.body)
    assert json.loads(section.body) == {
        "flow": 1,
        "protocol": "http",
        "host": "badsite1.org",
        "port": 1234,
        "username": "user1",
        "password": "mypass",
    }

    assert section.heuristic.heur_id == 103
    assert section.heuristic.attack_ids == []
    assert section.heuristic.signatures == {}
    assert section.heuristic.score == 0

    # log.warning(section.tags)
    assert section.tags == {
        "info.password": ["mypass"],
        "network.dynamic.domain": ["badsite1.org"],
        "network.port": [1234],
        "network.protocol": ["http"],
    }
    assert len(section.subsections) == 0


def test_when_val_in_body_but_no_tags_generated(
    hatching_result_instance: hatching_result_instance,
):
    """Validate that a Result is still created even though no tags are generated.

    A ResultKeyValueSection is created with the appropriate key-values, associated heuristic, and NO tags.
    """

    credentials = {
        "flow": 1,
        "username": "user1",
        "unk": "val",
    }

    section = hatching_result_instance._build_malware_extract_credentials_sub_section(
        credentials=credentials, is_static_analysis=True
    )

    assert section is not None
    assert section.title_text == "Extracted Credentials"
    assert section.body_format == BODY_FORMAT.KEY_VALUE

    # log.warning(section.body)
    assert json.loads(section.body) == {
        "flow": 1,
        "username": "user1",
        "unk": "val",
    }

    assert section.heuristic.heur_id == 103
    assert section.heuristic.attack_ids == []
    assert section.heuristic.signatures == {}
    assert section.heuristic.score == 0

    # log.warning(section.tags)
    assert section.tags == {}
    assert len(section.subsections) == 0


def test_tag_in_safelist_not_generated(
    hatching_result_instance: hatching_result_instance,
):
    """Validate that when a specific tag is in the safelist, it does not get generated when it otherwise would."""
    credentials = {
        "flow": 1,
        "protocol": "http",
        "host": "legitsite.local",
        "port": 1234,
        "username": "user1",
        "password": "mypass",
    }

    hatching_result_instance.safelist = {
        "match": {"network.static.domain": ["legitsite.local"]}
    }
    section = hatching_result_instance._build_malware_extract_credentials_sub_section(
        credentials=credentials, is_static_analysis=True
    )

    assert section is not None
    assert section.title_text == "Extracted Credentials"
    assert section.body_format == BODY_FORMAT.KEY_VALUE

    # log.warning(section.body)
    assert json.loads(section.body) == {
        "flow": 1,
        "protocol": "http",
        "host": "legitsite.local",
        "port": 1234,
        "username": "user1",
        "password": "mypass",
    }

    assert section.heuristic.heur_id == 103
    assert section.heuristic.attack_ids == []
    assert section.heuristic.signatures == {}
    assert section.heuristic.score == 0

    # log.warning(section.tags)
    assert section.tags == {
        "info.password": ["mypass"],
        "network.port": [1234],
        "network.protocol": ["http"],
    }
    assert len(section.subsections) == 0


def test_returns_none(
    hatching_result_instance: hatching_result_instance,
):
    """Validate the Result is returned as None when no data presented."""

    credentials = {}
    section = hatching_result_instance._build_malware_extract_credentials_sub_section(
        credentials=credentials, is_static_analysis=True
    )
    assert section is None

    credentials = None
    section = hatching_result_instance._build_malware_extract_credentials_sub_section(
        credentials=credentials, is_static_analysis=True
    )
    assert section is None


def test_result_section_key_value_uses_safe_vals(
    hatching_result_instance: hatching_result_instance,
):
    """Validate that the key-value section data uses data that has been sanitized."""

    credentials = {
        "encoded": b"\xff\xfet\x00e\x00s\x00t\x00",
        "nested_dict": {
            "nested_key_1": "nested_key_1val",
            "nested_key_2": "nested_key_2val",
        },
        "list_of_dicts": [{"key1": "key1val"}, {"key2": "key2val"}],
        "list_of_strs": ["valA", "valB"],
    }

    # log.warning(mal_cfg)
    section = hatching_result_instance._build_malware_extract_credentials_sub_section(
        credentials=credentials, is_static_analysis=True
    )

    assert section is not None

    # Validate the byte vals are flattened and converted
    # log.warning(section.body)
    assert json.loads(section.body) == {
        "encoded": "\\xff\\xfet\\x00e\\x00s\\x00t\\x00",
        "nested_dict.nested_key_1": "nested_key_1val",
        "nested_dict.nested_key_2": "nested_key_2val",
        "list_of_dicts.1.key1": "key1val",
        "list_of_dicts.2.key2": "key2val",
        "list_of_strs": ["valA", "valB"],
    }
